<script>
  const STORAGE_KEY = "clickHistory";

  const clickButton = document.getElementById("clickButton");
  const deleteButton = document.getElementById("deleteButton");
  const lastClickEl = document.getElementById("lastClick");
  const daysPassedEl = document.getElementById("daysPassed");
  const historyTable = document.getElementById("historyTable");

  function loadHistory() {
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved ? JSON.parse(saved) : [];
  }

  function saveHistory(history) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  }

  clickButton.addEventListener("click", () => {
    const now = new Date().toISOString();

    let history = loadHistory();
    history.unshift(now);

    history = history.slice(0, 100);

    saveHistory(history);
    updateDashboard(history);
    updateTable(history);
  });

  deleteButton.addEventListener("click", () => {
    const sicher = confirm("Wirklich ALLE Daten löschen?");
    if (!sicher) return;

    localStorage.removeItem(STORAGE_KEY);
    updateDashboard([]);
    updateTable([]);
  });

  function formatFullDiff(ms) {
    if (ms <= 0) return "0 T, 0 h, 0 min, 0 s";

    const sec = Math.floor(ms / 1000);
    const min = Math.floor(sec / 60);
    const hrs = Math.floor(min / 60);
    const days = Math.floor(hrs / 24);

    return `${days} T, ${hrs % 24} h, ${min % 60} min, ${sec % 60} s`;
  }

  function updateDashboard(history) {
    if (history.length === 0) {
      lastClickEl.textContent = "–";
      daysPassedEl.textContent = "–";
      return;
    }

    const lastDate = new Date(history[0]);
    lastClickEl.textContent = lastDate.toLocaleString("de-DE");

    const diffMs = Date.now() - lastDate.getTime();
    daysPassedEl.textContent = formatFullDiff(diffMs);
  }

  function getDiffString(d1, d2) {
    if (!d2) return "–";

    const diffMs = d1 - d2;
    return formatFullDiff(diffMs);
  }

  function updateTable(history) {
    historyTable.innerHTML = "";

    const last10 = history.slice(0, 10);

    last10.forEach((timestamp, index) => {
      const current = new Date(timestamp);
      const previous = last10[index + 1] ? new Date(last10[index + 1]) : null;

      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${current.toLocaleString("de-DE")}</td>
        <td>${getDiffString(current, previous)}</td>
      `;

      historyTable.appendChild(row);
    });
  }

  const history = loadHistory();
  updateDashboard(history);
  updateTable(history);

  // LIVE SEKUNDEN UPDATE
  setInterval(() => updateDashboard(loadHistory()), 1000);
</script>
